global
    daemon
    maxconn 4096
    log stdout local0
    stats socket /var/run/haproxy.sock mode 660 level admin
    stats timeout 30s

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    option httplog
    option dontlognull
    option log-health-checks
    retries 3
    option redispatch
    maxconn 2000

# Statistics page
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE

frontend weather_frontend
    bind *:80
    option httplog
    default_backend weather_backend
    
    # Add request ID for tracking
    http-request set-header X-Request-ID %[uuid()]
    
    # Log format for better debugging
    capture request header Host len 32
    capture request header User-Agent len 64

backend weather_backend
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    # Health check configuration
    default-server inter 10s fall 3 rise 2
    
    # Backend servers with proper health checks
    server web01 weather-app-web01:8080 check cookie web01
    server web02 weather-app-web02:8080 check cookie web02
    
    # Add backend server info to response
    http-response set-header X-Backend-Server %s
